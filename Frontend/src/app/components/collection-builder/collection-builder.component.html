<div class="form-container">
  
  <!-- Header -->
  <div class="header">
    <div class="title-group">
      <button mat-icon-button (click)="cancel()" class="back-btn" matTooltip="Volver">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div>
        <h1>{{ isEditMode ? 'Editar Colección' : 'Nueva Colección' }}</h1>
        <p class="subtitle">Define la estructura y el molde de tus datos</p>
      </div>
    </div>
    <div class="actions">
      <button mat-button (click)="cancel()" style="margin-right: 8px;">Cancelar</button>
      <button mat-flat-button color="primary" (click)="onSubmit()" [disabled]="collectionForm.invalid" class="save-btn">
        <mat-icon>save</mat-icon> Guardar
      </button>
    </div>
  </div>

  <form [formGroup]="collectionForm" class="main-layout">
    
    <!-- COLUMNA IZQUIERDA: IDENTIDAD -->
    <div class="identity-column">
      <mat-card class="identity-card">
        <div class="card-visual-header">
          <mat-icon>category</mat-icon>
        </div>
        <mat-card-content class="identity-content">
          
          <mat-form-field appearance="outline" class="full-width name-field">
            <mat-label>Nombre de la Colección</mat-label>
            <input matInput formControlName="name" placeholder="Ej. Zapatillas">
            <mat-error *ngIf="collectionForm.get('name')?.hasError('required')">Requerido</mat-error>
          </mat-form-field>

          <div class="info-box">
            <mat-icon>info</mat-icon>
            <p>Este nombre identificará tu colección en el dashboard y en los reportes.</p>
          </div>

        </mat-card-content>
      </mat-card>
    </div>

    <!-- COLUMNA DERECHA: ESTRUCTURA -->
    <div class="fields-column">
      <mat-card class="fields-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>view_list</mat-icon> Estructura de Campos
          </mat-card-title>
          <button mat-stroked-button color="primary" type="button" (click)="addField()">
            <mat-icon>add</mat-icon> Añadir Campo
          </button>
        </mat-card-header>
        
        <mat-card-content>
          <div formArrayName="fields" class="fields-list">
            
            <!-- Iteramos sobre cada campo -->
            <div *ngFor="let field of fields.controls; let i = index" [formGroupName]="i" class="field-row-card">
              
              <div class="field-header-strip">
                <span>Campo #{{ i + 1 }}</span>
                <button mat-icon-button color="warn" type="button" (click)="removeField(i)" matTooltip="Eliminar campo">
                  <mat-icon>close</mat-icon>
                </button>
              </div>

              <div class="field-body">
                <!-- Nombre -->
                <mat-form-field appearance="outline" density="dense">
                  <mat-label>Nombre (Ej. Talla)</mat-label>
                  <input matInput formControlName="name">
                </mat-form-field>

                <!-- Tipo -->
                <mat-form-field appearance="outline" density="dense">
                  <mat-label>Tipo de Dato</mat-label>
                  <mat-select formControlName="type">
                    <mat-option *ngFor="let type of fieldTypes" [value]="type.value">{{ type.label }}</mat-option>
                  </mat-select>
                </mat-form-field>

                <!-- Ancho -->
                <mat-form-field appearance="outline" density="dense">
                  <mat-label>Ancho en Formulario</mat-label>
                  <mat-select formControlName="width">
                    <mat-option value="full">Completo (100%)</mat-option>
                    <mat-option value="half">Medio (50%)</mat-option>
                  </mat-select>
                </mat-form-field>

                <!-- Opciones -->
                <mat-checkbox formControlName="required" color="primary">Obligatorio</mat-checkbox>
              </div>

              <!-- Panel de Opciones para Selectores -->
              <div *ngIf="field.get('type')?.value === 'selector'" class="selector-options-panel">
                <div formArrayName="options">
                  <div *ngFor="let optionGroup of getOptionsArray(i).controls; let j = index" [formGroupName]="j" class="option-item">
                    <mat-form-field appearance="outline" density="dense" class="full-width">
                      <mat-label>Opción {{ j + 1 }}</mat-label>
                      <input matInput formControlName="value" placeholder="Ej. Nuevo">
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline" density="dense" class="color-select">
                      <mat-label>Color</mat-label>
                      <mat-select formControlName="color">
                        <mat-option value="default">Gris</mat-option>
                        <mat-option value="success">Verde</mat-option>
                        <mat-option value="warning">Amarillo</mat-option>
                        <mat-option value="warn">Rojo</mat-option>
                        <mat-option value="primary">Azul</mat-option>
                      </mat-select>
                    </mat-form-field>

                    <button mat-icon-button color="warn" type="button" (click)="removeOption(getOptionsArray(i), j)">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </div>
                <button mat-button color="primary" type="button" (click)="addOption(getOptionsArray(i))">
                  <mat-icon>add</mat-icon> Añadir Opción
                </button>
              </div>

            </div>
          </div>

          <div *ngIf="fields.length === 0" class="empty-fields">
            <mat-icon>playlist_add</mat-icon>
            <p>No hay campos definidos. Añade uno para empezar.</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </form>
</div>
